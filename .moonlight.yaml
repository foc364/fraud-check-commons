sonar:
  enabled: true
  type: other

build:
    enabled: false

steps:
  - name: composer
    image: >-
      289208114389.dkr.ecr.us-east-1.amazonaws.com/picpay-dev/hyperf@sha256:e873217c00374b9de03f100555b79eacc218b0cd429ff49dd46929b7d8177868
    environment:
      COMPOSER_AUTH:
        from_secret: composer-auth
        key: COMPOSER_AUTH
      COMPOSER_PROCESS_TIMEOUT: 600
    commands:
      - composer validate --strict
      - composer install --no-interaction --optimize-autoloader

  - name: unit-tests
    image: >-
      289208114389.dkr.ecr.us-east-1.amazonaws.com/picpay-dev/hyperf@sha256:e873217c00374b9de03f100555b79eacc218b0cd429ff49dd46929b7d8177868
    environment:
      COMPOSER_PROCESS_TIMEOUT: 600
      DB_DATABASE: fraud-check-test
      DB_DSN: mongodb://localhost:27017
      FEEDZAI_JWT_PRIVATE_KEY_BASE64_ENCODED: >-
        LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS2dJQkFBS0NBZ0VBbnltbzAwMkJNQjRnOFg4N1RMQlFVYWVpczBhZkgzZlVjeUk4cVd1YUw3cjFvQ2RKClc2ZDJYTU9jZFlBVUNVamRXNXlsYzZiR1Z6UkJXL1V4QTk3K3lteFR1ZFlXUE5ja2pKbzFaMVYyQWFGWTBNbC8KV0ZjTkFJV3E4OUdINXJZNG9Lb1BOS1M0YUpCSzlWeW1rYkFKeklWSkNvNDh3b3NkY1cyQ1I0YngvY2ZrNlJMRQpjQUtBalZUeHk3V09NNEZuWEFocEpoV3g5eHRCUnl5OS85Q0RDMGVmYzZhY2ozWXVRdUtFcytlZVlyR0FvdlJoCjd6eTJibFhSTlFSaHI1TWZMall0UjRDVVhIaHZFbUs2MXhyelVQY1hsWXZuK2FiQjBVMXBGVjBiM0ZsUVEzbjkKZFJVUFVrZ2MyRUZlYkY0RExjaE9UQktCYlZZRDVGRUZoOXFrbkRrRSsveDdhQjdmWEQ1YUVTSlhXZ1ZlSnkrMwpsR0oxZ1pRbUJRY1hFRnkvbXlxSjJEWmRtL0lYb2JpUzJSaEZ0RUNrbmQvZWl5MmxLVHNwSXduV2FQeGVqTXJRClRyQ2I0VVl2MWZRdnBOYVlMUUlYRENJV1ZSZ3AzY09UYWhlU2doa0Y0dFQ1c2cyK0pZcU9qMU4rRmh4cEF1Y1cKZFpWVzJvRm1IMkM3cUdFU2dOelBpRmRDZ1NTVEJOTWR4UUpMRXd5QjlyQVo3WC9PY1oya1NOVUZ2dnQzd1BhNApmSVZmWE93WTJab2RXZ2hqZW1xa1YwS0ZnRlNxZ201cXRibjVwN1ZNV1JLd00yMWV6RHJJNys1clhyODNnTFVqCkdZZWtPNk8ydnBiamx2TmpGUmQ5UUlmM3VPVUtqSEEzVFFKYXJUNzcxKy92UVJTVDVMdjV3YUFReU5jQ0F3RUEKQVFLQ0FnRUFoVUVtdElvK0w5LzVxdGJmK2V2Znd3MTduV2J5RURHT01EcW8yUnRhZ3IyZnFjOWFqcDdjN1B0awp3Y2RTZnhkL0pKVTR2R1FUeUt6YVQ3Z3ZxbE1IdE1nUExSWjlsY0IyUERWYm9zRWRSRzRtWXQ5Z2U4Q2VCU0xrCkpxLzFmUVp3MEtxd2dsMnFldmpibVNOUjNjV3AzbzUwd1o2bVppWjhweHVOS0g5bG1SakRvUk55WFdqcTRla04KYTRUOG9raWtGWnlCRkQ2enVmUWFxaEZlblkrZ04xQm13amZxK2YxeTY5S2tVYzhJZnc2bmFVYjd1NFYwSTFvOApCb3c5a1BhMjgwU3VraCtubHVmSjduVzBnaVZ4TXdjOHVwcmd3OWFHak1xbndSZ3NIRWEyZVZmb0NSOXhyV3pzCm9XM1JOUjljdi9iay9yRzdwS09RTEpaYzhBbnhKL2xkYlBkOVc1WjEvQnFXamc4ZTNNSjh1QmRhQk50S0xBcFYKSWNWeXg4NFVSdWQ0UHJnK010a2VjTFd2SnQ0WDVLNjRUTkptTDRmeGc5MEc0eGQ0blQzWHNTN1BkdFdyeFlyawpxcG9KNU83dzhFNEovcElWSHhFSnlubDRwZG5SSStoTThEZmlhMStScW4wNG9BbW1FQmxBNDgwQU45cGo2Vi9lCjVMUVlXWWk5d1lvSGNpL3dvbkNCU1Iwa3d2T1lxcHQ1WjUzK1FzUUE4Y3FnQXV1WnRJaUlaN1YxQkhJc1IzajIKMDZ4c2FhcUdQWVJmeWRnQ01vR3hCQnFvSGRXbi8wK1VhR2hOeXc3QStCZCtWQjladFkrOW1nQVpqOVRTNUxUWAp5NHc4R1QxV0Jwd2hsSGd5VzRLb3FIY1ZXbWUwaVcxS3MyT0o3QkUySG56L25xZGl5UEVDZ2dFQkFPYXJtczJWCmhLblpnVGxqQTg1V1p2dkEzN2QrbStUUnU3M05OMkpnSjl2NVltVFlDSS80emh6SlM3VFZ3cmdUbXdmVFVxVDQKYVhiSnVUM2o3N09BS0tpZTZlb0FhVU9COGR6d2hjSEZudVZJdnY0QWgyVEFRR2RIcFQwblN5WGZ0QytxL0hocQo5bTJLZDRDdklEa1RkaWxpV093Uk9CSjVMdVpFeHJieGtUYzFYME1MMzFkZG5KNVNUclJubFJNTGhhVUtHZnI1Ckx1RTB2dUFTOElMZFR1TEo2YTFJeGQveFlYNk05NmxPS2VWSW5OcExOV3l2WHVXeXJNT256TDhnQVJnSWxGdjcKZjV6c0w5Q0g2ZkNTcVF5eG5aT1dvRER6bEFHNGFLM1lYZUFYOG5vcElzaEpJeERaSHFxUjFhZ1k1UkNtS0p6bgpUd0VjOWpZKzduR0pGbWtDZ2dFQkFMQ2o1ZUVyMllVbVBlMjlzYkVEazZIdWo4Ti9iUUU4QjhVZ0NTYXpxaFlsCkhLd1RJc2o1MjM0bm9wbk9OVElxV1pQQmg5NzhSblhkUlo5a3poNXBPbFJqV1hLY1k1U05JUm9aSGkyRFRVZ0QKUnBZckYxcFdTM1NvOTFOeDNoSVdaaFduL2lYZEhXRjJhL3VTYjNoeW5SUVdRYUVDc0ZnZGxoYkhQWTk3ODZjYwpyazNNVVpBM3ZtQ2FLY1prTHVXcGY4b0VKT0QxS2ZBUm5IcGRVZ1BJQkVwa1ZrbG1mRGpSck1jY2xjSTFWVGNrCjlqYmVacWpNZE04dVRXK2VVd2s0b1RvNlpTbVFhVVhzbHpjaFl5cVJVUGEweHo3cy9pWkRCZnVqR2ZyVXV3TU4KRlF2TkdBc3Y1NWxnZzVnMEpQbTE5TXQ1TmU2ZjV6eXhzblRHTnlYcmZUOENnZ0VCQU1iSzNYNlBmT1ZrTFpubgpXMEJYOWlqQThBeVRjSWFpdWNtNU1pSDEvR1AzYUhUQU9hRGFLOGRqTTN1RlBXcW1ldFVqcWZYQ29DRmZkK1YrCnF2Vm5YYUwwVVdMNU43NldIbnJxVGx2UWxEL0ZrZFFWWUpuVGxhMXNjVnRpb2NEaUtjZHE5R3BTeEUxako5b2YKRXdZZFg1Z0t5ZGVvZjBwc1paN05adlFDKzhNNG5BQ01HczZRUG9tekpXRVVZOFVtQ09kUzdWRDlyd2tuQzlqUQplYlpPUTgzdmRST0J4QVpiWUVwUDhxQldYSVRkTDFCeHdIa0tLaDZLL1prZzQ3TlRRWjRVeHNiKzE5dkZNTy9tCk1oYkNUaTVDWkNydGhPQ3JDc0x3eWtZSVVkN3V4R25EU2RhU01VWXoxOW5vRk5ucG1uL2VzdUdGOXZCZXBWSGEKcW1QdVlRRUNnZ0VBTytrYkN1Z29lclNoeElUV1E4ZUd4eUYydVVQNjRMUlBubGhqUWpFbHV5VVRPSG0xRHAxUQpDTlhBbkpJSUVOKzBTaDBWekZlY1BsV3lTNEdSTjFkUlpWWGMvTFoyUCtndUZmLzI4RkRjWVZSYkdJdTgrL0xRCjNOeUNKbGMwanNYeUVkNU1vT01DR0JCbVI0ay9MWWNTSjhIMHVIdUUvQjNzemdUOXFERE9UeHUzTXNQZDFpQlIKL2NuTDZYSUpSZlBiVjlWWC9NU3FXTFpnY0ZBK2hQSE9JcjB0VnUvZnFoWFRtQ1RsMWx6b2JpK25JcTBEL0xSNwoyZGxHZ2xrY3FNQUFUeE9IUkRXcXZ3Q2p1UnNsMjBZMlE3YkU3VjdNUklYdS9ZNHdQWmJ4WnZPRTg5KzRDL05QCmhnSHFJREZ2YVJLQjJKRmY3WE5tcG50T243U3E5NzJMV1FLQ0FRRUFqU1poNlR4M2dvc1pxSE1leVVwb1FIYVEKVDFTVGtYWDRPaTd1a1NMdkJndWtzcXFOUUZvU3FDSFFSTlhyTVZKc3ZPaTJZRS9QMVl3N3AxZ21xc0VRQWdJeApDQ2M5bml3aHNWUGM0MjVtUTlFNHRCdmJXNTl4c25Qd1NPRTNPYmFwbUhRV2xOV0hnUjZ3SkRWVGJTUmYzRDRoCkswN05XdkhXZHhvWWlRN2FTVzQ4c1N1RE1hMmFjVlV5S0RHN1lCT2dhdlJxODFoZFE1SmRkOVFrMjdoTkJUbGsKQ2VvTEpLejhvQk9hcm1pdHl4dm9jWWJpb3dLOVAwdW5zdE5iWnQ1VGhmNHVTUnZBbmFKWkpxY2VJZ0NwL3dESQphRzlLS2FTcm9OWTcxN3FSdmlqRnZHaTBGYjZkS2pxaTZOMFFUYm5pYXNXMnBMU3BSUG5EbTdVamErdCtBUT09Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
      FEEDZAI_JWT_PUBLIC_KEY_BASE64_ENCODED: >-
        LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQ0lqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FnOEFNSUlDQ2dLQ0FnRUFueW1vMDAyQk1CNGc4WDg3VExCUQpVYWVpczBhZkgzZlVjeUk4cVd1YUw3cjFvQ2RKVzZkMlhNT2NkWUFVQ1VqZFc1eWxjNmJHVnpSQlcvVXhBOTcrCnlteFR1ZFlXUE5ja2pKbzFaMVYyQWFGWTBNbC9XRmNOQUlXcTg5R0g1clk0b0tvUE5LUzRhSkJLOVZ5bWtiQUoKeklWSkNvNDh3b3NkY1cyQ1I0YngvY2ZrNlJMRWNBS0FqVlR4eTdXT000Rm5YQWhwSmhXeDl4dEJSeXk5LzlDRApDMGVmYzZhY2ozWXVRdUtFcytlZVlyR0FvdlJoN3p5MmJsWFJOUVJocjVNZkxqWXRSNENVWEhodkVtSzYxeHJ6ClVQY1hsWXZuK2FiQjBVMXBGVjBiM0ZsUVEzbjlkUlVQVWtnYzJFRmViRjRETGNoT1RCS0JiVllENUZFRmg5cWsKbkRrRSsveDdhQjdmWEQ1YUVTSlhXZ1ZlSnkrM2xHSjFnWlFtQlFjWEVGeS9teXFKMkRaZG0vSVhvYmlTMlJoRgp0RUNrbmQvZWl5MmxLVHNwSXduV2FQeGVqTXJRVHJDYjRVWXYxZlF2cE5hWUxRSVhEQ0lXVlJncDNjT1RhaGVTCmdoa0Y0dFQ1c2cyK0pZcU9qMU4rRmh4cEF1Y1dkWlZXMm9GbUgyQzdxR0VTZ056UGlGZENnU1NUQk5NZHhRSkwKRXd5QjlyQVo3WC9PY1oya1NOVUZ2dnQzd1BhNGZJVmZYT3dZMlpvZFdnaGplbXFrVjBLRmdGU3FnbTVxdGJuNQpwN1ZNV1JLd00yMWV6RHJJNys1clhyODNnTFVqR1lla082TzJ2cGJqbHZOakZSZDlRSWYzdU9VS2pIQTNUUUphCnJUNzcxKy92UVJTVDVMdjV3YUFReU5jQ0F3RUFBUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=
      FEEDZAI_JWT_TOKEN_TTL_MINUTES: '10'
      FEEDZAI_JWT_KEY_ID: '123456'
      APP_URL: app.ms-fraud-check-transaction
      FEEDZAI_PULSE_URL: https://picpay-sandbox.feedzai.com
    commands:
      - apk add --update ${PHPIZE_DEPS} boost-dev
      - pecl install pcov
      - >-
        wget -c https://github.com/swoole/yasd/archive/refs/heads/master.tar.gz
        -O - | tar -xz
      - docker-php-source extract
      - mv yasd-master /usr/src/php/ext/yasd
      - docker-php-ext-install yasd
      - docker-php-ext-enable pcov
      - echo "yasd.debug_mode=remote" >> /usr/local/etc/php/conf.d/yasd.ini
      - >-
        echo "yasd.remote_host=host.docker.internal" >>
        /usr/local/etc/php/conf.d/yasd.ini
      - echo "yasd.remote_port=9000" >> /usr/local/etc/php/conf.d/yasd.ini
      - composer run-script test:clover
    runAfter:
      - composer
